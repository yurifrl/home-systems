apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: bind9
  namespace: argocd
spec:
  project: default
  destination:
    server: https://kubernetes.default.svc
    namespace: bind9
  syncPolicy:
    automated:
      prune: true
      selfHeal: true
    syncOptions:
      - CreateNamespace=true
  source:
    repoURL: https://artem-shestakov.github.io/helm-charts
    chart: bind9
    targetRevision: "*"
    helm:
      valuesObject:
        resources:
          limits:
            cpu: 200m
            memory: 256Mi
          requests:
            cpu: 100m
            memory: 128Mi 
        env:
          - name: TZ
            value: America/Sao_Paulo
          - name: BIND9_USER
            value: bind
        service:
          type: LoadBalancer
          ports:
            - name: 53-53-tcp
              port: 53
              protocol: TCP
              target: 53
            - name: 53-53-udp
              port: 53
              protocol: UDP
              target: 53
        config:
          named.conf: |
            key "externaldns-key" {
                algorithm hmac-sha256;
                secret "96Ah/a2g0/nLeFGK+d/0tzQcccf9hCEIy34PoXX2Qg8=";
            };
            # ifconfig | grep "inet " | grep -v 127.0.0.1
            acl internal {
              192.168.0.0/16;    # All local networks in 192.168.x.x range
              198.19.0.0/16;     # Broader network range
              # 10.0.0.0/8;        # All kubernetes and internal networks
            };

            options {
              directory "/var/cache/bind";
              
              forwarders {
                1.1.1.1;
                1.0.0.1;
                8.8.8.8;
              };
            };

            zone "syscd.dev" IN {
                type master;
                file "/etc/bind/syscd.dev.zone";
                allow-transfer {
                    key "externaldns-key";
                };
                update-policy {
                    grant externaldns-key zonesub ANY;
                };
            };
          syscd.dev.zone: |
            $TTL 60 ; 1 minute
            syscd.dev         IN SOA  syscd.dev. root.syscd.dev. (
                                            16         ; serial
                                            60         ; refresh (1 minute)
                                            60         ; retry (1 minute)
                                            60         ; expire (1 minute)
                                            60         ; minimum (1 minute)
                                            )
                                    NS      ns.syscd.dev.
            ns                      A       192.168.68.203