apiVersion: monitoring.coreos.com/v1
kind: Probe
metadata:
  labels:
    probe: bind9
  name: bind9
  namespace: bind9
spec:
  interval: 30s
  module: dns_udp_53
  prober:
    path: /probe
    url: blackbox-exporter-prometheus-blackbox-exporter.monitoring.svc.cluster.local:9115
  targets:
    staticConfig:
      static:
        - 192.168.68.202:53
---
apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: bind9-probe
  namespace: monitoring
  labels:
    prometheus: k8s
    role: alert-rules
spec:
  jobLabel: probe/bind9/bind9
  podMetricsEndpoints:
    - port: http
      path: /probe
      interval: 30s
      scrapeTimeout: 15s
      params:
        module: ['dns']
        target: ['192.168.68.201:53']  # Your DNS server
        query_name: ['ha.syscd.dev']   # Domain to check
        query_type: ['A']              # Looking for A record
  selector:
    matchLabels:
      app.kubernetes.io/name: blackbox-exporter
  namespaceSelector:
    matchNames:
      - monitoring
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: blackbox-exporter-bind9-config
  namespace: monitoring
data:
  bind9.yaml: |
    modules:
      dns:
        prober: dns
        timeout: 5s
        dns:
          transport_protocol: "udp"
          preferred_ip_protocol: "ip4"
          query_name: "ha.syscd.dev"
          query_type: "A"
          validate_answer_rrs:
            fail_if_not_matches_regexp:
              - "ha\\.syscd\\.dev\\.\\s+\\d+\\s+IN\\s+A\\s+\\d+\\.\\d+\\.\\d+\\.\\d+"
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: bind9-rules
  namespace: monitoring
  labels:
    prometheus: k8s
    role: alert-rules
spec:
  groups:
    - name: bind9.rules
      rules:
        - alert: Bind9Down
          expr: up{job="probe/bind9/bind9"} == 0
          for: 5m
          labels:
            severity: critical
            service: dns
          annotations:
            summary: "Bind9 DNS server is down"
            description: "Bind9 instance has been down for more than 5 minutes."

        - alert: Bind9HighQueryLatency
          expr: |
            probe_dns_duration_seconds{job="probe/bind9/bind9", phase="resolve"} > 0.5
          for: 10m
          labels:
            severity: warning
            service: dns
          annotations:
            summary: "High DNS query latency"
            description: "DNS resolution time is taking longer than 500ms for more than 10 minutes."

        - alert: Bind9QueryFailures
          expr: |
            probe_dns_query_succeeded{job="probe/bind9/bind9"} == 0
          for: 5m
          labels:
            severity: warning
            service: dns
          annotations:
            summary: "DNS queries are failing"
            description: "DNS queries are failing for more than 5 minutes."

        # Recording rules for SLO monitoring
        - record: dns:probe_success_rate:5m
          expr: |
            avg_over_time(probe_success{job="probe/bind9/bind9"}[5m])

        - record: dns:probe_duration_seconds:5m
          expr: |
            avg_over_time(probe_dns_duration_seconds{job="probe/bind9/bind9", phase="resolve"}[5m])
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: bind9-homeassistant-dns-rules
  namespace: monitoring
  labels:
    prometheus: k8s
    role: alert-rules
spec:
  groups:
    - name: bind9-homeassistant.rules
      rules:
        - alert: HomeAssistantDNSResolutionFailing
          expr: |
            probe_success{job="probe/bind9/bind9"} == 0 or
            probe_dns_query_succeeded{job="probe/bind9/bind9"} == 0
          for: 5m
          labels:
            severity: critical
            service: dns
            domain: ha.syscd.dev
          annotations:
            summary: "DNS resolution failing for ha.syscd.dev"
            description: "Unable to resolve ha.syscd.dev through DNS for more than 5 minutes"

        - alert: HomeAssistantDNSHighLatency
          expr: |
            probe_dns_duration_seconds{job="probe/bind9/bind9", phase="resolve"} > 0.5
          for: 10m
          labels:
            severity: warning
            service: dns
            domain: ha.syscd.dev
          annotations:
            summary: "High DNS latency for ha.syscd.dev"
            description: "DNS resolution for ha.syscd.dev is taking longer than 500ms"

        # Recording rule for SLO tracking
        - record: dns:homeassistant_resolution_success:5m
          expr: |
            avg_over_time(probe_success{job="probe/bind9/bind9"}[5m])