{{- if .Values.stockChecker.enabled }}
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: {{ .Release.Name }}-ubiquiti-stock-checker
  namespace: {{ .Release.Namespace }}
spec:
  entrypoint: check-stock
  templates:
    - name: check-stock
      container:
        image: curlimages/curl:latest
        command: ["/bin/sh", "-c"]
        args:
          - |
            #!/bin/sh
            set -e

            PRODUCT_URL="https://br.store.ui.com/br/pt/category/all-door-access/products/eah-8"
            USER_AGENT="Mozilla/5.0"

            # Function to send Discord notification
            notify_discord() {
              local message="$1"
              curl -X POST \
                -H "Content-Type: application/json" \
                -d "{\"content\":\"$message\"}" \
                "$DISCORD_WEBHOOK" || echo "Failed to send Discord notification"
            }

            # Check if product is in stock
            echo "Checking stock for EAH-8..."
            if ! curl -sA "$USER_AGENT" "$PRODUCT_URL" | grep -q "Esgotado"; then
              echo "Product is in stock! Sending notification..."
              notify_discord "ðŸš¨ EAH-8 is in stock! Check $PRODUCT_URL"
            else
              echo "Product is out of stock"
            fi
        env:
          - name: DISCORD_WEBHOOK
            valueFrom:
              secretKeyRef:
                name: argo-workflows-stock-checker
                key: DISCORD_WEBHOOK_URL

---
apiVersion: argoproj.io/v1alpha1
kind: CronWorkflow
metadata:
  name: {{ .Release.Name }}-ubiquiti-stock-checker-cron
  namespace: {{ .Release.Namespace }}
spec:
  schedule: {{ .Values.stockChecker.schedule | default "*/15 * * * *" | quote }}
  concurrencyPolicy: Replace
  workflowSpec:
    workflowTemplateRef:
      name: {{ .Release.Name }}-ubiquiti-stock-checker
{{- end }} 