apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: {{ .Release.Name }}-mqtt-monitor
  namespace: {{ .Release.Namespace }}
spec:
  entrypoint: monitor-distance
  templates:
    - name: monitor-distance
      container:
        image: python:3.11-slim
        command: ["/bin/bash", "-c"]
        args:
          - |
            # Install required packages
            pip install --no-cache-dir paho-mqtt

            # Create the monitoring script
            cat > mqtt_watch.py << 'EOF'
            import paho.mqtt.client as mqtt
            import json
            import os

            def on_connect(client, userdata, flags, rc, properties=None):
                if rc == 0:
                    print("Connected successfully")
                    client.subscribe("zigbee2mqtt/0xa4c138616b4937b2")
                else:
                    print(f"Connection failed with code {rc}")

            def on_message(client, userdata, msg):
                try:
                    data = json.loads(msg.payload.decode())
                    if "target_distance" in data:
                        print(f"Distance: {data['target_distance']}")
                except Exception as e:
                    print(f"Error processing message: {e}")

            def on_disconnect(client, userdata, rc, properties=None):
                print(f"Disconnected with result code: {rc}")

            # Create MQTT client with protocol v5
            client = mqtt.Client(callback_api_version=mqtt.CallbackAPIVersion.VERSION2, protocol=mqtt.MQTTv5)
            
            # Set callbacks
            client.on_connect = on_connect
            client.on_message = on_message
            client.on_disconnect = on_disconnect

            print(f"Connecting to {os.getenv('MQTT_HOST')}:{os.getenv('MQTT_PORT')}")
            client.connect(os.getenv("MQTT_HOST"), int(os.getenv("MQTT_PORT")), 60)
            client.loop_forever()
            EOF

            # Run the script
            python mqtt_watch.py
        env:
          - name: MQTT_HOST
            value: "mosquitto.mosquitto.svc"
          - name: MQTT_PORT
            value: "1883"

---
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: {{ .Release.Name }}-mqtt-monitor
  namespace: {{ .Release.Namespace }}
spec:
  workflowTemplateRef:
    name: {{ .Release.Name }}-mqtt-monitor

