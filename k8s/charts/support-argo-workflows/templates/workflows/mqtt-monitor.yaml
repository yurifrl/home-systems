apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: {{ .Release.Name }}-mqtt-monitor
  namespace: {{ .Release.Namespace }}
spec:
  entrypoint: monitor-distance
  arguments:
    parameters:
      - name: mqtt_host
        value: mosquitto.mosquitto.svc
      - name: mqtt_port
        value: "1883"
  templates:
    - name: monitor-distance
      dag:
        tasks:
          - name: clone
            template: clone
          - name: run
            template: run
            arguments:
              parameters:
                - name: mqtt_host
                  value: "{{workflow.parameters.mqtt_host}}"
                - name: mqtt_port
                  value: "{{workflow.parameters.mqtt_port}}"
            dependencies: [clone]
            
    - name: clone
      inputs:
        artifacts:
          - name: repo
            path: /workspace
            git:
              repo: https://github.com/yurifrl/home-systems.git
              revision: HEAD
              
    - name: run
      inputs:
        parameters:
          - name: mqtt_host
          - name: mqtt_port
      container:
        image: ghcr.io/astral/uv:latest
        workingDir: /workspace/automations
        command: ["/bin/sh", "-c"]
        args:
          - |
            uv pip install -e .
            python mqtt_watch.py
        env:
          - name: MQTT_HOST
            value: "{{inputs.parameters.mqtt_host}}"
          - name: MQTT_PORT
            value: "{{inputs.parameters.mqtt_port}}"

---
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  name: {{ .Release.Name }}-mqtt-monitor
  namespace: {{ .Release.Namespace }}
spec:
  workflowTemplateRef:
    name: {{ .Release.Name }}-mqtt-monitor

